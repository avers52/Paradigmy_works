import unittest
from models import create_test_data
from queries import запрос_1_отделы_со_словом_отдел, запрос_2_средняя_зарплата_по_отделам, запрос_3_сотрудники_на_а

class TestQueries(unittest.TestCase):

    def setUp(self):
        self.отделы, self.сотрудники, _ = create_test_data()

    def test_запрос_1_отделы_со_словом_отдел(self):
        результат = запрос_1_отделы_со_словом_отдел(self.отделы, self.сотрудники)
        # Проверяем количество отделов
        self.assertEqual(len(результат), 5, "Должно быть 5 отделов")
        # Проверяем, что в каждом отделе есть сотрудники
        for item in результат:
            self.assertGreater(len(item["сотрудники"]), 0, f"В отделе {item['отдел']} нет сотрудников")

    def test_запрос_2_средняя_зарплата_по_отделам(self):
        результат = запрос_2_средняя_зарплата_по_отделам(self.отделы, self.сотрудники)
        # Проверяем, что список отсортирован по убыванию
        зарплаты = [средняя for _, средняя in результат]
        self.assertEqual(зарплаты, sorted(зарплаты, reverse=True))

        # Проверяем конкретное значение для Отдела разработки
        разработка = next((средняя for наим, средняя in результат if "разработки" in наим), None)
        self.assertAlmostEqual(разработка, 80666.67, places=2, msg="Средняя зарплата в Отделе разработки должна быть ~80666.67")

    def test_запрос_3_сотрудники_на_а(self):
        результат = запрос_3_сотрудники_на_а(self.отделы, self.сотрудники)
        фамилии = [s["фамилия"] for s in результат]
        # Должны быть Алексеев, Андреева, Афанасьев
        ожидаемые = {"Алексеев", "Андреева", "Афанасьев"}
        self.assertEqual(set(фамилии), ожидаемые, "Не все сотрудники на 'А' найдены")
        # Проверим, что у Алексеева указан правильный отдел
        алексеев = next(s for s in результат if s["фамилия"] == "Алексеев")
        self.assertEqual(алексеев["отдел"], "Отдел продаж", "Отдел Алексеева должен быть 'Отдел продаж'")

if __name__ == '__main__':
    unittest.main()